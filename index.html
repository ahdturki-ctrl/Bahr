<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>كاشف البحر الشعري + تمييز (ال) القمرية/الشمسية</title>
  <style>
    :root{
      --bg:#0b0f14;
      --card:#121826;
      --muted:#9aa4b2;
      --text:#e5e7eb;
      --accent:#7dd3fc;
      --good:#86efac;
      --warn:#fbbf24;
      --bad:#fb7185;
      --border:#243042;
      --sun:#fbbf24;
      --moon:#60a5fa;
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:linear-gradient(180deg,#070a10, #0b0f14 40%, #070a10);
      color:var(--text); font-family: system-ui, -apple-system, "Segoe UI", Tahoma, Arial, sans-serif;
      font-size: 19px; line-height:1.65;
    }
    .wrap{max-width:1100px; margin:0 auto; padding:24px 16px 40px;}
    header{margin-bottom:18px}
    h1{font-size:28px; margin:0 0 6px}
    .sub{color:var(--muted); margin:0}
    .grid{display:grid; gap:14px; grid-template-columns: 1fr;}
    .card{
      background:rgba(18,24,38,.88);
      border:1px solid var(--border);
      border-radius:18px;
      padding:16px;
      box-shadow: 0 12px 30px rgba(0,0,0,.25);
    }
    label{display:block; margin-bottom:8px; color:#cbd5e1}
    textarea{
      width:100%; min-height:130px; resize:vertical;
      border-radius:14px; border:1px solid var(--border);
      background:#0b1220; color:var(--text);
      padding:12px 12px; font-size:19px; line-height:1.7;
      outline:none;
    }
    textarea:focus{border-color:#3b82f6}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .btn{
      appearance:none; border:1px solid var(--border);
      background:#0b1220; color:var(--text);
      padding:10px 14px; border-radius:14px;
      cursor:pointer; font-size:18px;
    }
    .btn:hover{border-color:#3b82f6}
    .btn.primary{background:rgba(59,130,246,.18); border-color:rgba(59,130,246,.55)}
    .pill{
      display:inline-flex; gap:8px; align-items:center;
      padding:6px 10px; border-radius:999px;
      border:1px solid var(--border);
      background:rgba(2,6,23,.35);
      color:var(--muted);
      font-size:16px;
    }
    .kpi{
      display:grid; gap:10px;
      grid-template-columns: repeat(3, minmax(0,1fr));
    }
    .kpi .box{
      background:rgba(2,6,23,.35);
      border:1px solid var(--border);
      border-radius:16px;
      padding:12px;
    }
    .kpi .t{color:var(--muted); font-size:15px; margin-bottom:6px}
    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:18px;
      word-break:break-word;
    }
    .hint{color:var(--muted); font-size:16px; margin:10px 0 0}
    .warn{color:var(--warn)}
    .good{color:var(--good)}
    .bad{color:var(--bad)}
    table{width:100%; border-collapse:collapse; overflow:hidden; border-radius:14px; border:1px solid var(--border)}
    th,td{padding:10px 10px; border-bottom:1px solid var(--border); vertical-align:top}
    th{background:rgba(2,6,23,.45); text-align:right; font-weight:700}
    tr:last-child td{border-bottom:none}
    .small{font-size:16px; color:var(--muted)}

    /* تمييز اللام الشمسية/القمرية */
    .baytBox{
      background:rgba(2,6,23,.35);
      border:1px solid var(--border);
      border-radius:16px;
      padding:12px;
      line-height:2.0;
      font-size:20px;
      word-break:break-word;
    }
    .tag{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:3px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(2,6,23,.35);
      color:var(--muted);
      font-size:15px;
    }
    .sun{
      border-bottom: 2px solid var(--sun);
      background: rgba(251,191,36,.12);
      border-radius:10px;
      padding:2px 6px;
    }
    .moon{
      border-bottom: 2px solid var(--moon);
      background: rgba(96,165,250,.12);
      border-radius:10px;
      padding:2px 6px;
    }

    @media (max-width:720px){
      .kpi{grid-template-columns:1fr}
      h1{font-size:24px}
      body, textarea{font-size:18px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>كاشف البحر الشعري + تمييز (الـ) القمرية/الشمسية</h1>
      <p class="sub">أدخلي البيت (ويُفضّل مُشكَّلًا)، ويمكن الفصل بين الشطرين بعلامة <span class="mono">|</span> أو سطر جديد.</p>
    </header>

    <div class="grid">
      <section class="card">
        <label for="bayt">البيت</label>
        <textarea id="bayt" placeholder="مثال: الشَّمْسُ طَالِعَةٌ | وَالقَمَرُ مُنِيرٌ"></textarea>

        <div class="row" style="margin-top:10px">
          <button class="btn primary" id="analyze">حلّل وحدّد البحر</button>
          <button class="btn" id="demo">جرّب مثالًا</button>
          <button class="btn" id="clear">مسح</button>
          <span class="pill">/** = متحرّك، 0 = ساكن</span>
          <span class="pill">تنبيه: بلا تشكيل = ساكن (0)</span>
        </div>

        <p class="hint">
          ملاحظة: الآن أي حرف بلا تشكيل يُحسب ساكنًا (0) كما طلبتِ؛ هذا قد يجعل الوزن أكثر “انكماشًا” إن كان النص غير مُشكَّل.
        </p>
      </section>

      <section class="card">
        <h2 style="margin:0 0 10px; font-size:22px">تمييز (الـ) القمرية/الشمسية</h2>
        <div class="row" style="margin-bottom:10px">
          <span class="tag"><span class="moon">قمرية</span> لام ظاهرة (لْ)</span>
          <span class="tag"><span class="sun">شمسية</span> لام مدغمة (والحرف التالي مشدد)</span>
          <span class="tag">حركة ألف الوصل عند الابتداء: (اَ)</span>
        </div>

        <div id="baytMarked" class="baytBox">—</div>

        <div style="margin-top:12px; overflow:auto">
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>الكلمة</th>
                <th>النوع</th>
                <th>حركة ألف الوصل</th>
                <th>حالة اللام</th>
                <th>الكتابة العروضية (مقترحة)</th>
              </tr>
            </thead>
            <tbody id="alRows">
              <tr><td colspan="6" class="small">أدخلي نصًا ثم اضغطي: حلّل وحدّد البحر</td></tr>
            </tbody>
          </table>
        </div>

        <p class="hint small">
          “الكتابة العروضية” هنا تعني: إظهار ما يُنطق وما يُدغم؛ في الشمسية تُحذف اللام نطقًا ويُشدَّد الحرف الشمسي (نمثل الشدّة بتكرار الحرف).
        </p>
      </section>

      <section class="card">
        <div class="kpi">
          <div class="box">
            <div class="t">حالة الإدخال</div>
            <div id="vowelState" class="mono">—</div>
          </div>
          <div class="box">
            <div class="t">نمط الشطر الأوّل</div>
            <div id="pat1" class="mono">—</div>
          </div>
          <div class="box">
            <div class="t">نمط الشطر الثاني</div>
            <div id="pat2" class="mono">—</div>
          </div>
        </div>
        <p class="hint small">
          التقطيع يحاول مراعاة: السكون، الشدّة (تفكيكها إلى ساكن + متحرّك)، التنوين (حركة + نون ساكنة)، وحروف المدّ بعد حركة مناسبة.
        </p>
      </section>

      <section class="card">
        <h2 style="margin:0 0 10px; font-size:22px">النتيجة</h2>
        <div id="resultLead" class="hint">—</div>

        <div style="margin-top:12px; overflow:auto">
          <table>
            <thead>
              <tr>
                <th>الترتيب</th>
                <th>البحر</th>
                <th>الوزن (تفعيلات كل شطر)</th>
                <th>درجة التطابق</th>
                <th>تفاصيل التقطيع (تفعيلات مُستنتجة)</th>
              </tr>
            </thead>
            <tbody id="rows">
              <tr><td colspan="5" class="small">أدخلي بيتًا ثم اضغطي: حلّل وحدّد البحر</td></tr>
            </tbody>
          </table>
        </div>
      </section>
    </div>
  </div>

<script>
(() => {
  // ====== ثوابت عربية ======
  const AR_LETTER = /[\u0621-\u064A\u0671-\u06D3\u06FA-\u06FF]/;
  const HARAKAT = /[\u064B-\u0652\u0670]/g; // تنوين/حركات/سكون + ألف خنجرية
  const SHADDA = "\u0651";
  const SUKUN  = "\u0652";
  const FATHA  = "\u064E";
  const DAMMA  = "\u064F";
  const KASRA  = "\u0650";
  const TANWIN_F = "\u064B"; // ً
  const TANWIN_D = "\u064C"; // ٌ
  const TANWIN_K = "\u064D"; // ٍ
  const DAGGER_A = "\u0670"; // ٰ

  const SUN_LETTERS = new Set(["ت","ث","د","ذ","ر","ز","س","ش","ص","ض","ط","ظ","ل","ن"]); // الحروف الشمسية
  const VOWELS_SET = new Set([FATHA, DAMMA, KASRA, TANWIN_F, TANWIN_D, TANWIN_K, DAGGER_A, SUKUN, SHADDA]);

  const el = (id) => document.getElementById(id);
  const setText = (id, txt, cls) => { const n = el(id); n.className = cls || "mono"; n.textContent = txt; };

  function normalizeArabic(s){
    return (s || "")
      .replace(/ـ/g,"")                          // تطويل
      .replace(/[“”"']/g,"")
      .replace(/[(),.;:!?؟…]/g," ")
      .replace(/[0-9٠-٩]/g," ")
      .replace(/\s+/g," ")
      .trim();
  }

  function splitShatrain(s){
    if (s.includes("|")) {
      const parts = s.split("|").map(x=>x.trim()).filter(Boolean);
      return [parts[0] || "", parts[1] || ""];
    }
    if (s.includes("\n")) {
      const parts = s.split("\n").map(x=>x.trim()).filter(Boolean);
      return [parts[0] || "", parts[1] || ""];
    }
    return [s.trim(), ""];
  }

  // ====== تمييز (الـ) القمرية/الشمسية ======
  function isHarakaChar(ch){
    return VOWELS_SET.has(ch);
  }

  function skipHarakat(str, idx){
    let i = idx;
    while (i < str.length && isHarakaChar(str[i])) i++;
    return i;
  }

  function getNextArabicLetter(str, idx){
    // يرجع أول حرف عربي بعد idx مع تجاوز الحركات
    let i = idx;
    while (i < str.length){
      if (isHarakaChar(str[i])) { i++; continue; }
      if (AR_LETTER.test(str[i])) return {ch:str[i], index:i};
      i++;
    }
    return null;
  }

  function analyzeALInText(text){
    // نحافظ على النص كما هو للتلوين، ونحلله كلمة-كلمة
    const original = (text || "").trim();
    if (!original) return {marked:"—", items:[]};

    // تقسيم كلمات مع الحفاظ على الفواصل البسيطة عبر split ثم إعادة بناء
    const tokens = original.split(/(\s+)/); // يضمن بقاء المسافات
    const items = [];
    let marked = "";

    for (let t of tokens){
      if (/^\s+$/.test(t)) { marked += t; continue; }

      // نظّف طرفي الكلمة من الرموز الشائعة لكن اترك داخلها
      const rawWord = t;
      const stripped = rawWord.replace(/^[\u200f\u200e"'“”‘’\(\)\[\]\{\}\.,;:!?؟]+|[\u200f\u200e"'“”‘’\(\)\[\]\{\}\.,;:!?؟]+$/g, "");

      // موقع stripped داخل rawWord
      const pre = rawWord.slice(0, rawWord.indexOf(stripped));
      const post = rawWord.slice(rawWord.indexOf(stripped) + stripped.length);

      // تحقّق: تبدأ بـ "ال" أو "ٱل"
      const w = stripped;
      const starts =
        (w.startsWith("ال") ? 2 :
         (w.startsWith("ٱل") ? 2 : 0));
      if (!starts){
        marked += rawWord;
        continue;
      }

      // بعد الألف واللام، تجاوز حركات على اللام إن وُجدت
      const lamIdx = 1; // في "ال" اللام عند 1
      const afterLam = skipHarakat(w, lamIdx+1);
      const nxt = getNextArabicLetter(w, afterLam);

      if (!nxt){
        marked += rawWord;
        continue;
      }

      const sun = SUN_LETTERS.has(nxt.ch);
      const kind = sun ? "شمسية" : "قمرية";
      const kindCls = sun ? "sun" : "moon";

      // استخراج بقية الكلمة بعد اللام (بما فيها الحرف التالي وما بعده)
      const restAfterLam = w.slice(afterLam);

      // كتابة عروضية مقترحة
      // ألف الوصل عند الابتداء: (اَ)
      // القمرية: اَلْ + بقية الكلمة (اللام منطوقة ساكنة)
      // الشمسية: اَ + (الحرف الشمسي مكرر) + بقية الكلمة بدون اللام
      let arudi = "";
      if (!sun){
        arudi = "اَلْ" + restAfterLam;
      } else {
        // كرّر الحرف الشمسي للدلالة على الشدّة (مع الإبقاء على بقية الكلمة)
        // مثال: الشَّمْس → اَشْشَّمْس (تقريبًا)
        // سنكرر حرف nxt.ch ثم نلحق بقية restAfterLam كما هي
        arudi = "اَ" + nxt.ch + restAfterLam;     // النسخة الأولى
        arudi = "اَ" + nxt.ch + restAfterLam;     // ثم نضيف تكرارًا في العرض
        // لجعل التكرار واضحًا: نضعه حرفيًا مرتين قبل restAfterLam بدون أول حرف
        arudi = "اَ" + nxt.ch + nxt.ch + restAfterLam.slice(nxt.index - afterLam + 1);
      }

      const item = {
        word: stripped,
        kind,
        hamzaWasl: "اَ (عند الابتداء)",
        lamState: sun ? "لام ساكنة مدغمة (لا تُنطق)" : "لام ساكنة ظاهرة (تُنطق)",
        arudi
      };
      items.push(item);

      // تلوين الكلمة كاملة (للوضوح)، ويمكنك لاحقًا تلوين "ال" فقط إن رغبتِ
      marked += pre + `<span class="${kindCls}" title="${kind}">${stripped}</span>` + post;
    }

    return {marked, items};
  }

  // ====== تحويل النص إلى سلسلة /0 (مع تعديل: بلا تشكيل = ساكن) ======
  function tokenizeLettersWithMarks(text){
    const out = [];
    const s = text;
    for (let i=0; i<s.length; i++){
      const ch = s[i];
      if (!AR_LETTER.test(ch)) continue;

      let marks = "";
      let j = i+1;
      while (j < s.length && HARAKAT.test(s[j])) {
        marks += s[j];
        j++;
      }
      HARAKAT.lastIndex = 0;
      out.push({ch, marks});
      i = j-1;
    }
    return out;
  }

  function hasAnyVowel(marks){
    return marks.includes(FATHA) || marks.includes(DAMMA) || marks.includes(KASRA) ||
           marks.includes(TANWIN_F) || marks.includes(TANWIN_D) || marks.includes(TANWIN_K) ||
           marks.includes(DAGGER_A);
  }

  function vowelType(marks){
    if (marks.includes(FATHA) || marks.includes(TANWIN_F) || marks.includes(DAGGER_A)) return "a";
    if (marks.includes(DAMMA) || marks.includes(TANWIN_D)) return "u";
    if (marks.includes(KASRA) || marks.includes(TANWIN_K)) return "i";
    return "";
  }

  function isLongVowelLetter(ch){
    return ch === "ا" || ch === "و" || ch === "ي" || ch === "ى";
  }

  function extractPattern(text){
    const raw = normalizeArabic(text);

    const marksCount = (raw.match(HARAKAT) || []).length;
    HARAKAT.lastIndex = 0;
    const lettersCount = (raw.match(/[\u0621-\u064A\u0671-\u06D3\u06FA-\u06FF]/g) || []).length;
    const vowelRatio = lettersCount ? (marksCount / lettersCount) : 0;

    const tokens = tokenizeLettersWithMarks(raw);
    let pat = "";

    for (let i=0; i<tokens.length; i++){
      const t = tokens[i];
      const m = t.marks || "";

      // شدّة: ساكن ثم التالي بحسب حركة الحرف
      if (m.includes(SHADDA)) pat += "0";

      if (m.includes(SUKUN)) {
        pat += "0";
      } else if (hasAnyVowel(m)) {
        pat += "/";
        // تنوين: حركة + نون ساكنة
        if (m.includes(TANWIN_F) || m.includes(TANWIN_D) || m.includes(TANWIN_K)) pat += "0";
      } else {
        // === التعديل المطلوب ===
        // بلا تشكيل = ساكن
        pat += "0";
      }

      // حروف المد بعد حركة مناسبة (إن وُجدت الحركة على الحرف السابق)
      const vt = vowelType(m);
      if (vt && i+1 < tokens.length) {
        const n = tokens[i+1];
        const nm = n.marks || "";
        if (!hasAnyVowel(nm) && !nm.includes(SUKUN) && isLongVowelLetter(n.ch)) {
          const ok =
            (vt === "a" && (n.ch === "ا" || n.ch === "ى")) ||
            (vt === "u" && n.ch === "و") ||
            (vt === "i" && n.ch === "ي");
          if (ok){
            pat += "0";
            i++;
          }
        }
      }
    }

    pat = pat.replace(/[^\/0]/g,"");
    return {pattern: pat, vowelRatio, lettersCount, marksCount, raw};
  }

  // ====== تفعيلات ورموزها (/0) ======
  const FEET = [
    { base:"فعولن", variants:["//0/0","//0//"] },
    { base:"مفاعيلن", variants:["//0/0/0","//0//0","//0/0"] },
    { base:"مفاعلتن", variants:["//0///0","//0//0"] },
    { base:"متفاعلن", variants:["///0//0","//0//0"] },
    { base:"فاعلاتن", variants:["/0//0/0","///0/0"] },
    { base:"فاعلن", variants:["/0//0","///0","/0/0"] },
    { base:"مستفعلن", variants:["/0/0//0","//0//0","/0//0"] },
  ];

  const METERS = [
    { name:"الطويل",  tmpl:["فعولن","مفاعيلن","فعولن","مفاعيلن"], note:"قد يأتي في العروض/الضرب: مفاعلن (تقريبًا)" },
    { name:"البسيط",  tmpl:["مستفعلن","فاعلن","مستفعلن","فاعلن"], note:"شائع فيه خبن/قطع في فاعلن" },
    { name:"الكامل",  tmpl:["متفاعلن","متفاعلن","متفاعلن"], note:"" },
    { name:"الوافر",  tmpl:["مفاعلتن","مفاعلتن","فعولن"], note:"" },
    { name:"الرمل",   tmpl:["فاعلاتن","فاعلاتن","فاعلاتن"], note:"" },
    { name:"الرجز",   tmpl:["مستفعلن","مستفعلن","مستفعلن"], note:"" },
    { name:"الخفيف",  tmpl:["فاعلاتن","مستفعلن","فاعلاتن"], note:"" },
    { name:"الهزج",   tmpl:["مفاعيلن","مفاعيلن"], note:"" },
    { name:"المتقارب",tmpl:["فعولن","فعولن","فعولن","فعولن"], note:"" },
    { name:"المتدارك",tmpl:["فاعلن","فاعلن","فاعلن","فاعلن"], note:"" },
    { name:"المديد",  tmpl:["فاعلاتن","فاعلن","فاعلاتن"], note:"" },
  ];

  function segmentToFeet(pattern){
    const n = pattern.length;
    const dp = Array(n+1).fill(null);
    dp[0] = {cost:0, seq:[]};

    for (let i=0; i<n; i++){
      if (!dp[i]) continue;

      for (const f of FEET){
        for (const v of f.variants){
          if (pattern.startsWith(v, i)){
            const j = i + v.length;
            const nextCost = dp[i].cost;
            const nextSeq = dp[i].seq.concat([{base:f.base, var:v}]);
            if (!dp[j] || nextCost < dp[j].cost){
              dp[j] = {cost:nextCost, seq:nextSeq};
            }
          }
        }
      }

      // سماح بتجاوز رمز واحد (أخطاء تشكيل)
      const skipCost = dp[i].cost + 1;
      const j = i + 1;
      if (!dp[j] || skipCost < dp[j].cost){
        dp[j] = {cost:skipCost, seq:dp[i].seq.concat([{base:"(تجاوز)", var:pattern[i]}])};
      }
    }

    let best = null;
    for (let k=0; k<=n; k++){
      if (!dp[k]) continue;
      const tailPenalty = (n-k);
      const total = dp[k].cost + tailPenalty;
      if (!best || total < best.total){
        best = {end:k, total, seq:dp[k].seq, leftover: pattern.slice(k)};
      }
    }
    return best || {end:0, total:n, seq:[], leftover:pattern};
  }

  function editDistance(a, b){
    const m = a.length, n = b.length;
    const d = Array.from({length:m+1}, ()=>Array(n+1).fill(0));
    for (let i=0;i<=m;i++) d[i][0]=i;
    for (let j=0;j<=n;j++) d[0][j]=j;
    for (let i=1;i<=m;i++){
      for (let j=1;j<=n;j++){
        const cost = (a[i-1]===b[j-1]) ? 0 : 1;
        d[i][j] = Math.min(d[i-1][j]+1, d[i][j-1]+1, d[i-1][j-1]+cost);
      }
    }
    return d[m][n];
  }

  function scoreMeter(predFeet, meterTmpl, penalty){
    const dist = editDistance(predFeet, meterTmpl);
    const base = Math.max(predFeet.length, meterTmpl.length, 1);
    const dist2 = dist + Math.min(6, penalty);
    const conf = Math.max(0, 1 - (dist2 / (base + 2)));
    return {dist: dist2, conf};
  }

  function analyzeOneShatr(text){
    const info = extractPattern(text);
    const seg = segmentToFeet(info.pattern);
    const predFeet = seg.seq.filter(x=>x.base!=="(تجاوز)").map(x=>x.base);
    const penalty = seg.total;

    const candidates = METERS.map(m=>{
      const sc = scoreMeter(predFeet, m.tmpl, penalty);
      return { name:m.name, tmpl:m.tmpl.join(" "), conf: sc.conf, dist: sc.dist, note:m.note };
    }).sort((x,y)=>y.conf - x.conf);

    return {info, seg, predFeet, candidates};
  }

  function fmtPct(x){ return Math.round(x*100) + "%"; }
  function confidenceClass(c){
    if (c >= 0.80) return "good";
    if (c >= 0.55) return "warn";
    return "bad";
  }

  function renderMeterResults(a1, a2){
    const top = [];
    for (let i=0;i<Math.min(3, a1.candidates.length); i++){
      const c1 = a1.candidates[i];
      let conf = c1.conf;
      let details = `الشطر 1: ${a1.predFeet.join(" ")}${a1.seg.leftover ? " | بقايا: "+a1.seg.leftover : ""}`;

      if (a2 && a2.info && a2.info.raw.trim()){
        const c2 = a2.candidates.find(x=>x.name===c1.name) || a2.candidates[0];
        conf = (c1.conf + (c2 ? c2.conf : 0)) / 2;
        details += `<br>الشطر 2: ${a2.predFeet.join(" ")}${a2.seg.leftover ? " | بقايا: "+a2.seg.leftover : ""}`;
      }

      top.push({...c1, conf, details});
    }

    const rows = el("rows");
    rows.innerHTML = "";

    if (!top.length){
      rows.innerHTML = `<tr><td colspan="5" class="small">لم نستطع استخراج نتيجة.</td></tr>`;
      return;
    }

    top.forEach((t, idx)=>{
      const cls = confidenceClass(t.conf);
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${idx+1}</td>
        <td><strong>${t.name}</strong><div class="small">${t.note || ""}</div></td>
        <td class="mono">${t.tmpl}</td>
        <td class="${cls}"><strong>${fmtPct(t.conf)}</strong></td>
        <td class="small">${t.details}</td>
      `;
      rows.appendChild(tr);
    });

    const lead = el("resultLead");
    const best = top[0];
    lead.innerHTML = `أقرب نتيجة: <strong>${best.name}</strong> بدرجة تطابق <strong class="${confidenceClass(best.conf)}">${fmtPct(best.conf)}</strong>.`;
  }

  function setStateBadge(vowelRatio){
    if (vowelRatio >= 0.35) return {txt:"مُشكَّل بدرجة جيدة", cls:"mono good"};
    if (vowelRatio >= 0.15) return {txt:"تشكيل قليل (النتيجة قد تتذبذب)", cls:"mono warn"};
    return {txt:"بلا تشكيل تقريبًا (ومع قاعدة السكون قد يضعف الوزن)", cls:"mono bad"};
  }

  function renderALSection(text){
    const res = analyzeALInText(text);
    el("baytMarked").innerHTML = res.marked || "—";

    const body = el("alRows");
    body.innerHTML = "";
    if (!res.items.length){
      body.innerHTML = `<tr><td colspan="6" class="small">لا توجد كلمات تبدأ بـ (الـ) في النص المعطى.</td></tr>`;
      return;
    }
    res.items.forEach((it, idx)=>{
      const tr = document.createElement("tr");
      const cls = (it.kind === "شمسية") ? "sun" : "moon";
      tr.innerHTML = `
        <td>${idx+1}</td>
        <td><strong>${it.word}</strong></td>
        <td><span class="${cls}">${it.kind}</span></td>
        <td>${it.hamzaWasl}</td>
        <td>${it.lamState}</td>
        <td class="mono">${it.arudi}</td>
      `;
      body.appendChild(tr);
    });
  }

  // ====== أزرار ======
  el("analyze").addEventListener("click", ()=>{
    const input = el("bayt").value || "";
    const [s1, s2] = splitShatrain(input);

    // 1) تمييز (الـ)
    renderALSection(input);

    // 2) تحليل البحر
    const a1 = analyzeOneShatr(s1);
    const a2 = s2.trim() ? analyzeOneShatr(s2) : null;

    const st = setStateBadge(a1.info.vowelRatio + (a2 ? a2.info.vowelRatio : 0));
    setText("vowelState", st.txt, st.cls);

    setText("pat1", a1.info.pattern || "—", "mono");
    setText("pat2", a2 ? (a2.info.pattern || "—") : "—", "mono");

    renderMeterResults(a1, a2);
  });

  el("demo").addEventListener("click", ()=>{
    el("bayt").value = "الشَّمْسُ تُنِيرُ الدُّنْيَا | وَالقَمَرُ فِي اللَّيْلِ سَنَا";
  });

  el("clear").addEventListener("click", ()=>{
    el("bayt").value = "";
    setText("vowelState","—");
    setText("pat1","—");
    setText("pat2","—");
    el("resultLead").textContent = "—";
    el("rows").innerHTML = `<tr><td colspan="5" class="small">أدخلي بيتًا ثم اضغطي: حلّل وحدّد البحر</td></tr>`;
    el("baytMarked").textContent = "—";
    el("alRows").innerHTML = `<tr><td colspan="6" class="small">أدخلي نصًا ثم اضغطي: حلّل وحدّد البحر</td></tr>`;
  });

})();
</script>
</body>
</html>
