<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>تحليل عروض: النمط والبحر + (الـ) + الشدة + منع التقاء ساكنين</title>
  <style>
    :root{
      --card:#121826; --muted:#9aa4b2; --text:#e5e7eb;
      --good:#86efac; --warn:#fbbf24; --bad:#fb7185;
      --border:#243042; --sun:#fbbf24; --moon:#60a5fa; --shadda:#c084fc;
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:linear-gradient(180deg,#070a10, #0b0f14 40%, #070a10);
      color:var(--text);
      font-family: system-ui, -apple-system, "Segoe UI", Tahoma, Arial, sans-serif;
      font-size: 19px; line-height:1.65;
    }
    .wrap{max-width:1250px; margin:0 auto; padding:24px 16px 40px;}
    header{margin-bottom:18px}
    h1{font-size:28px; margin:0 0 6px}
    .sub{color:var(--muted); margin:0}
    .grid{display:grid; gap:14px; grid-template-columns: 1fr;}
    .card{
      background:rgba(18,24,38,.88);
      border:1px solid var(--border);
      border-radius:18px;
      padding:16px;
      box-shadow: 0 12px 30px rgba(0,0,0,.25);
    }
    label{display:block; margin-bottom:8px; color:#cbd5e1}
    textarea{
      width:100%; min-height:120px; resize:vertical;
      border-radius:14px; border:1px solid var(--border);
      background:#0b1220; color:var(--text);
      padding:12px 12px; font-size:19px; line-height:1.7;
      outline:none;
    }
    textarea:focus{border-color:#3b82f6}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .btn{
      appearance:none; border:1px solid var(--border);
      background:#0b1220; color:var(--text);
      padding:10px 14px; border-radius:14px;
      cursor:pointer; font-size:18px;
    }
    .btn:hover{border-color:#3b82f6}
    .btn.primary{background:rgba(59,130,246,.18); border-color:rgba(59,130,246,.55)}
    .pill{
      display:inline-flex; gap:8px; align-items:center;
      padding:6px 10px; border-radius:999px;
      border:1px solid var(--border);
      background:rgba(2,6,23,.35);
      color:var(--muted);
      font-size:16px;
    }
    .kpi{
      display:grid; gap:10px;
      grid-template-columns: repeat(3, minmax(0,1fr));
    }
    .kpi2{
      display:grid; gap:10px;
      grid-template-columns: 1fr 1fr;
      margin-top:10px;
    }
    .kpi .box,.kpi2 .box{
      background:rgba(2,6,23,.35);
      border:1px solid var(--border);
      border-radius:16px;
      padding:12px;
    }
    .kpi .t,.kpi2 .t{color:var(--muted); font-size:15px; margin-bottom:6px}
    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:18px;
      word-break:break-word;
    }
    .warn{color:var(--warn)}
    .good{color:var(--good)}
    .bad{color:var(--bad)}
    table{width:100%; border-collapse:collapse; overflow:hidden; border-radius:14px; border:1px solid var(--border)}
    th,td{padding:10px 10px; border-bottom:1px solid var(--border); vertical-align:top}
    th{background:rgba(2,6,23,.45); text-align:right; font-weight:700}
    tr:last-child td{border-bottom:none}
    .small{font-size:16px; color:var(--muted)}
    .baytBox{
      background:rgba(2,6,23,.35);
      border:1px solid var(--border);
      border-radius:16px;
      padding:12px;
      line-height:2.0;
      font-size:20px;
      word-break:break-word;
    }
    .tag{
      display:inline-flex; align-items:center; gap:8px;
      padding:3px 10px; border-radius:999px;
      border:1px solid var(--border);
      background:rgba(2,6,23,.35);
      color:var(--muted);
      font-size:15px;
    }
    .sun{border-bottom:2px solid var(--sun); background:rgba(251,191,36,.12); border-radius:10px; padding:2px 6px;}
    .moon{border-bottom:2px solid var(--moon); background:rgba(96,165,250,.12); border-radius:10px; padding:2px 6px;}
    .shadda{border-bottom:2px solid var(--shadda); background:rgba(192,132,252,.12); border-radius:10px; padding:2px 6px;}
    .sectionTitle{margin:0 0 10px; font-size:22px}
    .split2{display:grid; grid-template-columns:1fr 1fr; gap:14px}
    @media (max-width:900px){
      .kpi{grid-template-columns:1fr}
      .kpi2{grid-template-columns:1fr}
      .split2{grid-template-columns:1fr}
      h1{font-size:24px}
      body, textarea{font-size:18px}
    }
    .radioGroup{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      padding:10px; border:1px solid var(--border); border-radius:14px;
      background:rgba(2,6,23,.28);
    }
    .radioGroup label{margin:0; color:var(--text); font-size:16px}
    .chip{display:inline-flex; gap:8px; align-items:center; padding:4px 10px; border:1px solid var(--border); border-radius:999px; background:rgba(2,6,23,.35); color:var(--muted); font-size:15px}
    .err{color:var(--bad); white-space:pre-wrap}
    .toggleLine{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      padding:10px; border:1px solid var(--border); border-radius:14px;
      background:rgba(2,6,23,.28);
      margin-top:10px;
    }
    .toggleLine label{margin:0; color:var(--text); font-size:16px}
    .meterList{
      margin:0; padding:0 18px 0 0;
    }
    .meterList li{margin:6px 0}
    .score{color:var(--muted); font-size:15px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>تحليل عروض: النمط والبحر</h1>
      <p class="sub">
        النتيجة الأساسية (النمط + ترجيح البحر) تظهر هنا. التفاصيل (النص العروضي والجداول) اختيارية.
      </p>
    </header>

    <div class="grid">
      <section class="card">
        <label for="bayt">البيت</label>
        <textarea id="bayt" placeholder="مثال: وَضِياءُ القَمَرِ في اللَّيْلِ | وَالشَّمْسُ في الصَّبَاحِ"></textarea>

        <div class="row" style="margin-top:10px">
          <button class="btn primary" id="analyze">حلّل</button>
          <button class="btn" id="demo">جرّب مثالًا</button>
          <button class="btn" id="clear">مسح</button>
          <span class="pill">/ = متحرك، 0 = ساكن</span>
        </div>

        <div class="row" style="margin-top:10px">
          <div class="radioGroup" title="كيف نحسب الحروف غير المشكلة في التقطيع">
            <span class="chip">الحرف بلا تشكيل يُحسب:</span>
            <label><input type="radio" name="unvowel" value="0" checked> ساكن (0)</label>
            <label><input type="radio" name="unvowel" value="/"> متحرك (/)</label>
          </div>
        </div>

        <div class="toggleLine" title="إظهار/إخفاء التفاصيل (النص العروضي والجداول)">
          <label><input type="checkbox" id="showDetails"> إظهار التفاصيل (النص العروضي + الجداول)</label>
          <span class="chip">التفاصيل ليست ضرورية لمعرفة النمط والبحر</span>
        </div>

        <div id="errBox" class="err" style="margin-top:10px; display:none"></div>
      </section>

      <!-- ====== النتيجة الأساسية ====== -->
      <section class="card">
        <div class="kpi">
          <div class="box">
            <div class="t">حالة الإدخال</div>
            <div id="vowelState" class="mono">—</div>
          </div>
          <div class="box">
            <div class="t">نمط الشطر الأوّل</div>
            <div id="pat1" class="mono">—</div>
          </div>
          <div class="box">
            <div class="t">نمط الشطر الثاني</div>
            <div id="pat2" class="mono">—</div>
          </div>
        </div>

        <div class="kpi2">
          <div class="box">
            <div class="t">البحر المرجّح (تقريبي)</div>
            <div id="bestBahr" class="mono">—</div>
            <div id="bestBahrNote" class="small" style="margin-top:6px">—</div>
          </div>
          <div class="box">
            <div class="t">أقرب بحور (أفضل 5)</div>
            <ol id="topBahrs" class="meterList small">
              <li>—</li>
            </ol>
          </div>
        </div>

        <p class="small" style="margin-top:10px">
          ملاحظة: ترجيح البحر يعتمد على مطابقة النمط (/0) مع أوزان “سليمة” للتفعيلات، وقد يختلف مع كثرة الزحافات/العلل أو مع قلة التشكيل.
        </p>
      </section>

      <section class="card">
        <h2 class="sectionTitle">عرض بصري داخل النص</h2>
        <div class="row" style="margin-bottom:10px">
          <span class="tag"><span class="sun">شمسية</span></span>
          <span class="tag"><span class="moon">قمرية</span></span>
          <span class="tag"><span class="shadda">شدّة</span></span>
        </div>
        <div id="baytVisual" class="baytBox">—</div>
      </section>

      <!-- ====== التفاصيل (مخفية افتراضيًا) ====== -->
      <div id="detailsWrap" style="display:none">
        <section class="card">
          <h2 class="sectionTitle">النص العروضي المستخدم للتقطيع</h2>
          <div class="split2">
            <div>
              <div class="chip">الشطر الأول (عروضي)</div>
              <div id="arudi1" class="baytBox mono">—</div>
            </div>
            <div>
              <div class="chip">الشطر الثاني (عروضي)</div>
              <div id="arudi2" class="baytBox mono">—</div>
            </div>
          </div>
          <p class="small" style="margin-top:10px">
            ملاحظة: هنا يظهر تعديل منع التقاء ساكنين (حذف حرف المد قبل لْ في القمرية وصلاً).
          </p>
        </section>

        <section class="card">
          <h2 class="sectionTitle">تمييز (الـ) القمرية/الشمسية</h2>
          <div style="overflow:auto; margin-top:10px">
            <table>
              <thead>
                <tr>
                  <th>#</th>
                  <th>الكلمة</th>
                  <th>النوع</th>
                  <th>ألف الوصل</th>
                  <th>ملاحظة عروضية</th>
                </tr>
              </thead>
              <tbody id="alRows">
                <tr><td colspan="5" class="small">اكتبي نصًا ثم اضغطي: حلّل</td></tr>
              </tbody>
            </table>
          </div>
        </section>

        <section class="card">
          <h2 class="sectionTitle">التقطيع التفصيلي</h2>
          <div class="split2">
            <div>
              <div class="chip">الشطر الأول</div>
              <div style="margin-top:10px; overflow:auto">
                <table>
                  <thead>
                    <tr>
                      <th>#</th>
                      <th>الأصل</th>
                      <th>العروضي للتقطيع</th>
                      <th>نمط /0</th>
                      <th>ملاحظات</th>
                    </tr>
                  </thead>
                  <tbody id="w1"><tr><td colspan="5" class="small">—</td></tr></tbody>
                </table>
              </div>

              <div style="margin-top:12px; overflow:auto">
                <table>
                  <thead>
                    <tr>
                      <th>الموقع</th>
                      <th>حرف + حركاته</th>
                      <th>/0</th>
                      <th>التفسير</th>
                    </tr>
                  </thead>
                  <tbody id="cs1"><tr><td colspan="4" class="small">—</td></tr></tbody>
                </table>
              </div>
            </div>

            <div>
              <div class="chip">الشطر الثاني</div>
              <div style="margin-top:10px; overflow:auto">
                <table>
                  <thead>
                    <tr>
                      <th>#</th>
                      <th>الأصل</th>
                      <th>العروضي للتقطيع</th>
                      <th>نمط /0</th>
                      <th>ملاحظات</th>
                    </tr>
                  </thead>
                  <tbody id="w2"><tr><td colspan="5" class="small">—</td></tr></tbody>
                </table>
              </div>

              <div style="margin-top:12px; overflow:auto">
                <table>
                  <thead>
                    <tr>
                      <th>الموقع</th>
                      <th>حرف + حركاته</th>
                      <th>/0</th>
                      <th>التفسير</th>
                    </tr>
                  </thead>
                  <tbody id="cs2"><tr><td colspan="4" class="small">—</td></tr></tbody>
                </table>
              </div>
            </div>
          </div>
        </section>
      </div>

    </div>
  </div>

<script>
(() => {
  // ====== ثوابت ======
  const AR_LETTER = /[\u0621-\u064A\u0671-\u06D3\u06FA-\u06FF]/;
  const HARAKAT_RE = /[\u064B-\u0652\u0670]/g;
  const SHADDA = "\u0651";
  const SUKUN  = "\u0652";
  const FATHA  = "\u064E";
  const DAMMA  = "\u064F";
  const KASRA  = "\u0650";
  const TANWIN_F = "\u064B";
  const TANWIN_D = "\u064C";
  const TANWIN_K = "\u064D";
  const DAGGER_A = "\u0670";

  const SUN_LETTERS = new Set(["ت","ث","د","ذ","ر","ز","س","ش","ص","ض","ط","ظ","ل","ن"]);
  const VOWELS_SET = new Set([FATHA, DAMMA, KASRA, TANWIN_F, TANWIN_D, TANWIN_K, DAGGER_A, SUKUN, SHADDA]);

  const el = (id) => document.getElementById(id);
  const setText = (id, txt, cls) => { const n = el(id); if (cls) n.className = cls; n.textContent = txt; };

  function showErr(e){
    const b = el("errBox");
    b.style.display = "block";
    b.textContent = String(e && (e.stack || e.message || e) || e);
  }
  window.addEventListener("error", (ev) => showErr(ev.error || ev.message));

  function getUnvowelMode(){
    return document.querySelector('input[name="unvowel"]:checked')?.value || "0";
  }

  function normalizeSoftKeepHarakat(s){
    return (s || "").replace(/ـ/g,"").replace(/[“”"']/g,"").replace(/\s+/g," ").trim();
  }
  function normalizeForPattern(s){
    return (s || "")
      .replace(/ـ/g,"")
      .replace(/[“”"']/g,"")
      .replace(/[(),.;:!?؟…]/g," ")
      .replace(/[0-9٠-٩]/g," ")
      .replace(/\s+/g," ")
      .trim();
  }
  function splitShatrain(s){
    if ((s || "").includes("|")) {
      const parts = s.split("|").map(x=>x.trim()).filter(Boolean);
      return [parts[0] || "", parts[1] || ""];
    }
    if ((s || "").includes("\n")) {
      const parts = s.split("\n").map(x=>x.trim()).filter(Boolean);
      return [parts[0] || "", parts[1] || ""];
    }
    return [s.trim(), ""];
  }
  function escapeHtml(str){
    return (str || "").replace(/[&<>"']/g, (m)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
  }
  function stripEdgePunctKeepHarakat(w){
    return (w || "").replace(/^[\u200f\u200e"'“”‘’\(\)\[\]\{\}\.,;:!?؟]+|[\u200f\u200e"'“”‘’\(\)\[\]\{\}\.,;:!?؟]+$/g, "");
  }

  function isHarakaChar(ch){ return VOWELS_SET.has(ch); }

  function tokenizeLettersWithMarks(text){
    const out = [];
    const s = text;
    for (let i = 0; i < s.length; i++){
      const ch = s[i];
      if (!AR_LETTER.test(ch)) continue;

      let marks = "";
      let j = i + 1;
      while (j < s.length && isHarakaChar(s[j])) { marks += s[j]; j++; }
      out.push({ ch, marks });
      i = j - 1;
    }
    return out;
  }
  function tokensToString(tokens){
    return tokens.map(t => t.ch + (t.marks||"")).join("");
  }

  function hasAnyVowel(marks){
    return marks.includes(FATHA) || marks.includes(DAMMA) || marks.includes(KASRA) ||
           marks.includes(TANWIN_F) || marks.includes(TANWIN_D) || marks.includes(TANWIN_K) ||
           marks.includes(DAGGER_A);
  }
  function removeShortVowelsKeepShaddaSukun(marks){
    return (marks || "")
      .replace(new RegExp(`[${FATHA}${DAMMA}${KASRA}${TANWIN_F}${TANWIN_D}${TANWIN_K}${DAGGER_A}]`, "g"), "");
  }

  function isLongVowelLetter(ch){
    return ch === "ا" || ch === "و" || ch === "ي" || ch === "ى";
  }

  // ====== منع التقاء ساكنين: حذف حرف المد قبل "لْ" ======
  function dropMaddBeforeLamSukun(prevArudi, nextArudi){
    if (!prevArudi || !nextArudi) return prevArudi;

    const nt = tokenizeLettersWithMarks(nextArudi);
    if (!(nt[0] && nt[0].ch === "ل" && (nt[0].marks || "").includes(SUKUN))) return prevArudi;

    const pt = tokenizeLettersWithMarks(prevArudi);
    if (pt.length < 2) return prevArudi;

    const last = pt[pt.length - 1];
    const before = pt[pt.length - 2];

    const lastMarks = last.marks || "";
    const isPureMadd =
      isLongVowelLetter(last.ch) &&
      !hasAnyVowel(lastMarks) &&
      !lastMarks.includes(SUKUN) &&
      !lastMarks.includes(SHADDA);

    const beforeMarks = before.marks || "";
    const hasVowelBefore = hasAnyVowel(beforeMarks);

    if (isPureMadd && hasVowelBefore){
      pt.pop();
      return tokensToString(pt);
    }
    return prevArudi;
  }

  function markTextVisual(text){
    const s = normalizeSoftKeepHarakat(text);
    if (!s) return "—";
    const tokens = s.split(/(\s+)/);
    let out = "";

    for (const tok of tokens){
      if (/^\s+$/.test(tok)) { out += tok; continue; }
      const w = stripEdgePunctKeepHarakat(tok);

      function markShaddaInWord(word){
        let res = "";
        for (let i=0; i<word.length; i++){
          const ch = word[i];
          if (!AR_LETTER.test(ch)) { res += escapeHtml(ch); continue; }

          let marks = "";
          let j = i+1;
          while (j < word.length && isHarakaChar(word[j])) { marks += word[j]; j++; }

          const chunk = escapeHtml(ch + marks);
          res += marks.includes(SHADDA) ? `<span class="shadda">${chunk}</span>` : chunk;
          i = j-1;
        }
        return res;
      }

      let kindCls = "";
      {
        const tk2 = tokenizeLettersWithMarks(w);
        if (tk2.length >= 2){
          let lamIndex = -1;
          if ((tk2[0].ch==="ا" || tk2[0].ch==="ٱ") && tk2[1].ch==="ل") lamIndex = 1;
          else if (tk2.length >= 3 && "وفبكل".includes(tk2[0].ch) && (tk2[1].ch==="ا" || tk2[1].ch==="ٱ") && tk2[2].ch==="ل") lamIndex = 2;
          else if (tk2[0].ch==="ل" && tk2[1].ch==="ل") lamIndex = 1;

          if (lamIndex >= 0 && tk2[lamIndex+1]){
            kindCls = SUN_LETTERS.has(tk2[lamIndex+1].ch) ? "sun" : "moon";
          }
        }
      }

      const mw = markShaddaInWord(w);
      out += kindCls ? `<span class="${kindCls}">${mw}</span>` : mw;
    }
    return out || "—";
  }

  // ==== (الـ) ====
  // القمرية: حذف الألف وصلاً + إثبات اللام بالسكون
  // الشمسية: داخل الجملة (وصلاً) حذف الألف واللام فقط، وابتداءً حذف اللام فقط
  function makeArudiWordForTaqti3(originalWord, ibtida){
    const w = stripEdgePunctKeepHarakat(originalWord);
    const tk = tokenizeLettersWithMarks(w);
    if (tk.length < 2) return {orig:w, arudi:w, note:"—"};

    let lamIndex = -1;
    let alifIndex = -1;

    if ((tk[0].ch==="ا" || tk[0].ch==="ٱ") && tk[1].ch==="ل"){
      alifIndex = 0; lamIndex = 1;
    } else if (tk.length >= 3 && "وفبكل".includes(tk[0].ch) && (tk[1].ch==="ا" || tk[1].ch==="ٱ") && tk[2].ch==="ل"){
      alifIndex = 1; lamIndex = 2; ibtida = false;
    } else if (tk[0].ch==="ل" && tk[1].ch==="ل"){
      alifIndex = -1; lamIndex = 1; ibtida = false;
    } else {
      return {orig:w, arudi:w, note:"—"};
    }

    const next = tk[lamIndex + 1];
    if (!next) return {orig:w, arudi:w, note:"—"};
    const isSun = SUN_LETTERS.has(next.ch);

    // همزة الوصل
    if (alifIndex >= 0){
      if (!ibtida){
        tk.splice(alifIndex, 1);
        if (lamIndex > alifIndex) lamIndex -= 1;
      } else {
        const m = tk[alifIndex].marks || "";
        if (!hasAnyVowel(m) && !m.includes(SUKUN)){
          tk[alifIndex].marks = m + FATHA;
        }
      }
    }

    let note = "—";

    if (!isSun){
      const lamTok = tk[lamIndex];
      lamTok.marks = removeShortVowelsKeepShaddaSukun(lamTok.marks || "");
      if (!lamTok.marks.includes(SUKUN)) lamTok.marks += SUKUN;
      note = "قمرية: إثبات اللام بالسكون + همزة الوصل حسب الموضع";
    } else {
      if (!ibtida) {
        // وصلاً: حذف الألف واللام فقط
        if (tk[lamIndex] && tk[lamIndex].ch==="ل"){
          tk.splice(lamIndex, 1);
        }
        note = "شمسية (وصلاً): حذف الألف واللام فقط";
      } else {
        // ابتداءً: حذف اللام فقط
        if (tk[lamIndex] && tk[lamIndex].ch==="ل"){
          tk.splice(lamIndex, 1);
        }
        note = "شمسية (ابتداءً): حذف اللام فقط";
      }
    }

    return {orig:w, arudi: tokensToString(tk), note};
  }

  function splitWordsForArudi(shatr){
    const s = normalizeSoftKeepHarakat(shatr);
    if (!s) return [];
    const parts = s.split(/(\s+|[،؛.!?؟…:]+)/).filter(p => p !== "");
    const out = [];
    let canIbtida = true;

    for (const p of parts){
      if (/^\s+$/.test(p)) continue;
      if (/^[،؛.!?؟…:]+$/.test(p)) { canIbtida = true; continue; }

      out.push({word: p, ibtida: canIbtida});
      canIbtida = false;
    }
    return out;
  }

  function makeArudiShatr(shatr){
    const words = splitWordsForArudi(shatr);
    const mapped = [];
    const arudiWords = [];

    for (let i=0; i<words.length; i++){
      const ow = words[i].word;
      const r = makeArudiWordForTaqti3(ow, words[i].ibtida);
      mapped.push({idx:i+1, orig:r.orig, arudi:r.arudi, note:r.note});
      arudiWords.push(r.arudi);
    }

    // منع التقاء ساكنين بين الكلمات
    for (let i=0; i<arudiWords.length - 1; i++){
      const fixedPrev = dropMaddBeforeLamSukun(arudiWords[i], arudiWords[i+1]);
      if (fixedPrev !== arudiWords[i]){
        arudiWords[i] = fixedPrev;
        mapped[i].arudi = fixedPrev;
        mapped[i].note = (mapped[i].note && mapped[i].note !== "—")
          ? (mapped[i].note + " + حذف حرف المد قبل لْ (منع التقاء ساكنين)")
          : "حذف حرف المد قبل لْ (منع التقاء ساكنين)";
      }
    }

    return {arudiText: arudiWords.join(" "), map: mapped};
  }

  function vowelType(marks){
    if (marks.includes(FATHA) || marks.includes(TANWIN_F) || marks.includes(DAGGER_A)) return "a";
    if (marks.includes(DAMMA) || marks.includes(TANWIN_D)) return "u";
    if (marks.includes(KASRA) || marks.includes(TANWIN_K)) return "i";
    return "";
  }

  function analyzeWordPatternDetailed(wordArudi){
    const mode = getUnvowelMode();
    const tks = tokenizeLettersWithMarks(wordArudi);
    let p = "";
    const steps = [];

    for (let i=0; i<tks.length; i++){
      const t = tks[i];
      const m = t.marks || "";

      if (m.includes(SHADDA)){
        p += "0";
        steps.push({display: t.ch + m, sym:"0", why:"شدّة: جزء ساكن (0)"});
      }

      if (m.includes(SUKUN)) {
        p += "0";
        steps.push({display: t.ch + m, sym:"0", why:"سكون: ساكن (0)"});
      } else if (hasAnyVowel(m)) {
        p += "/";
        steps.push({display: t.ch + m, sym:"/", why:"حركة: متحرك (/)"});

        // التنوين: تركناه كما هو (حسب طلبك السابق)
        if (m.includes(TANWIN_F) || m.includes(TANWIN_D) || m.includes(TANWIN_K)){
          p += "0";
          steps.push({display: "ـنْ (ضمن التنوين)", sym:"0", why:"تنوين: نون ساكنة"});
        }
      } else {
        p += mode;
        steps.push({display: t.ch, sym:mode, why:(mode==="0" ? "بلا تشكيل: ساكن (حسب اختيارك)" : "بلا تشكيل: متحرك (حسب اختيارك)")});
      }

      // المدّ: ساكن بعد حركة مناسبة
      const vt = vowelType(m);
      if (vt && i+1 < tks.length) {
        const n = tks[i+1];
        const nm = n.marks || "";
        if (!hasAnyVowel(nm) && !nm.includes(SUKUN) && isLongVowelLetter(n.ch)) {
          const ok =
            (vt === "a" && (n.ch === "ا" || n.ch === "ى")) ||
            (vt === "u" && n.ch === "و") ||
            (vt === "i" && n.ch === "ي");
          if (ok){
            p += "0";
            steps.push({display: n.ch, sym:"0", why:"مدّ: ساكن (0)"});
            i++;
          }
        }
      }
    }

    return {pattern:p.replace(/[^\/0]/g,""), steps};
  }

  function analyzeShatrDetailedFromArudi(arudiText, map){
    const raw = normalizeForPattern(arudiText);
    const marksCount = (raw.match(HARAKAT_RE) || []).length;
    const lettersCount = (raw.match(/[\u0621-\u064A\u0671-\u06D3\u06FA-\u06FF]/g) || []).length;
    const vowelRatio = lettersCount ? (marksCount / lettersCount) : 0;

    let pattern = "";
    let steps = [];
    let pos = 0;

    const wordRows = (map || []).map((m, i)=>{
      const r = analyzeWordPatternDetailed(m.arudi);
      pattern += r.pattern;
      for (const st of r.steps){
        steps.push({pos: ++pos, display: st.display, sym: st.sym, why: st.why});
      }
      return {idx:i+1, orig:m.orig, arudi:m.arudi, pat:r.pattern, note:m.note};
    });

    return {pattern: pattern.replace(/[^\/0]/g,""), vowelRatio, wordRows, steps};
  }

  function setStateBadge(vowelRatio){
    if (vowelRatio >= 0.35) return {txt:"مُشكَّل بدرجة جيدة", cls:"mono good"};
    if (vowelRatio >= 0.15) return {txt:"تشكيل قليل", cls:"mono warn"};
    return {txt:"بلا تشكيل تقريبًا", cls:"mono bad"};
  }

  function analyzeALRows(text){
    const original = (text || "").trim();
    if (!original) return {items:[]};

    const parts = normalizeSoftKeepHarakat(original).split(/\s+/).filter(Boolean);
    const items = [];

    for (let i=0; i<parts.length; i++){
      const raw = stripEdgePunctKeepHarakat(parts[i]);
      const tk = tokenizeLettersWithMarks(raw);
      if (tk.length < 2) continue;

      let lamIndex = -1, alifIndex = -1, ibtida = (i===0);

      if ((tk[0].ch==="ا" || tk[0].ch==="ٱ") && tk[1].ch==="ل"){
        alifIndex = 0; lamIndex = 1;
      } else if (tk.length >= 3 && "وفبكل".includes(tk[0].ch) && (tk[1].ch==="ا" || tk[1].ch==="ٱ") && tk[2].ch==="ل"){
        alifIndex = 1; lamIndex = 2; ibtida = false;
      } else if (tk[0].ch==="ل" && tk[1].ch==="ل"){
        alifIndex = -1; lamIndex = 1; ibtida = false;
      } else continue;

      const next = tk[lamIndex+1];
      if (!next) continue;

      const isSun = SUN_LETTERS.has(next.ch);
      const kind = isSun ? "شمسية" : "قمرية";
      const hamzaWasl = (alifIndex>=0 ? (ibtida ? "تُنطق ابتداءً" : "لا تُنطق وصلاً") : "لا ألف");
      const note = isSun
        ? (ibtida ? "ابتداءً: حذف اللام فقط" : "وصلاً: حذف الألف واللام فقط")
        : "وصلاً: لْ في البداية (قد يسبب التقاء ساكنين)";

      items.push({ word: raw, kind, hamzaWasl, note });
    }
    return {items};
  }

  function renderALTable(items){
    const body = el("alRows");
    body.innerHTML = "";
    if (!items.length){
      body.innerHTML = `<tr><td colspan="5" class="small">لا توجد كلمات تبدأ بـ (الـ) في النص.</td></tr>`;
      return;
    }
    items.forEach((it, idx)=>{
      const tr = document.createElement("tr");
      const cls = (it.kind === "شمسية") ? "sun" : "moon";
      tr.innerHTML = `
        <td>${idx+1}</td>
        <td><strong>${escapeHtml(it.word)}</strong></td>
        <td><span class="${cls}">${it.kind}</span></td>
        <td>${escapeHtml(it.hamzaWasl)}</td>
        <td class="small">${escapeHtml(it.note)}</td>
      `;
      body.appendChild(tr);
    });
  }

  function renderWordTable(tbodyId, wordRows){
    const body = el(tbodyId);
    body.innerHTML = "";
    if (!wordRows.length){
      body.innerHTML = `<tr><td colspan="5" class="small">—</td></tr>`;
      return;
    }
    wordRows.forEach(r=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${r.idx}</td>
        <td><strong>${escapeHtml(r.orig)}</strong></td>
        <td class="mono">${escapeHtml(r.arudi)}</td>
        <td class="mono">${escapeHtml(r.pat)}</td>
        <td class="small">${escapeHtml(r.note)}</td>
      `;
      body.appendChild(tr);
    });
  }

  function renderCharSteps(tbodyId, steps){
    const body = el(tbodyId);
    body.innerHTML = "";
    if (!steps.length){
      body.innerHTML = `<tr><td colspan="4" class="small">—</td></tr>`;
      return;
    }
    steps.forEach(s=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${s.pos}</td>
        <td class="mono">${escapeHtml(s.display)}</td>
        <td class="mono"><strong>${escapeHtml(s.sym)}</strong></td>
        <td class="small">${escapeHtml(s.why)}</td>
      `;
      body.appendChild(tr);
    });
  }

  // ====== مطابقة البحور عبر /0 ======
  const TAFAEEL = {
    "فعولن":   "//0/0",
    "فاعلن":   "/0//0",
    "مفاعيلن": "//0/0/0",
    "فاعلاتن": "/0//0/0",
    "مستفعلن": "/0/0//0",
    "متفاعلن": "///0//0",
    "مفاعلتن": "//0///0"
  };

  const BAHR_DEFS = [
    {name:"المتقارب", variants:[["فعولن","فعولن","فعولن","فعولن"]]},
    {name:"المتدارك", variants:[["فاعلن","فاعلن","فاعلن","فاعلن"]]},
    {name:"الهزج",    variants:[["مفاعيلن","مفاعيلن"]]},
    {name:"الرجز",    variants:[["مستفعلن","مستفعلن","مستفعلن"]]},
    {name:"الكامل",   variants:[["متفاعلن","متفاعلن","متفاعلن"]]},
    {name:"الرمل",    variants:[["فاعلاتن","فاعلاتن","فاعلاتن"]]},
    {name:"الوافر",   variants:[["مفاعلتن","مفاعلتن","فعولن"]]},
    {name:"السريع",   variants:[["مستفعلن","مستفعلن","فاعلن"]]},
    {name:"المديد",   variants:[["فاعلاتن","فاعلن","فاعلاتن"]]},
    // الطويل له صور متعددة؛ نضع الأشهر سليماً (فعولن مفاعيلن فعولن مفاعيلن) كمرجع أساسي
    {name:"الطويل",   variants:[["فعولن","مفاعيلن","فعولن","مفاعيلن"]]},
    // البسيط: الأشهر سليماً (مستفعلن فاعلن مستفعلن فاعلن) كمرجع
    {name:"البسيط",   variants:[["مستفعلن","فاعلن","مستفعلن","فاعلن"]]}
  ];

  function buildPatternFromTafaeel(seq){
    return seq.map(x => TAFAEEL[x] || "").join("");
  }

  function levenshtein(a,b){
    const m=a.length, n=b.length;
    if (!m) return n;
    if (!n) return m;
    const dp = new Array(n+1);
    for (let j=0;j<=n;j++) dp[j]=j;
    for (let i=1;i<=m;i++){
      let prev = dp[0];
      dp[0]=i;
      for (let j=1;j<=n;j++){
        const tmp = dp[j];
        const cost = a[i-1]===b[j-1] ? 0 : 1;
        dp[j] = Math.min(
          dp[j]+1,
          dp[j-1]+1,
          prev + cost
        );
        prev = tmp;
      }
    }
    return dp[n];
  }

  function scorePattern(inputPat, templatePat){
    const a = (inputPat||"").replace(/[^\/0]/g,"");
    const b = (templatePat||"").replace(/[^\/0]/g,"");
    if (!a || !b) return 0;
    const dist = levenshtein(a,b);
    const denom = Math.max(a.length, b.length);
    return Math.max(0, 1 - (dist/denom));
  }

  function rankBahrsForShatr(pat){
    const out = [];
    for (const b of BAHR_DEFS){
      let best = 0;
      let bestVar = null;
      for (const v of b.variants){
        const tpat = buildPatternFromTafaeel(v);
        const sc = scorePattern(pat, tpat);
        if (sc > best){
          best = sc; bestVar = v;
        }
      }
      out.push({name:b.name, score:best, tafaeel:(bestVar||[])});
    }
    out.sort((x,y)=>y.score-x.score);
    return out;
  }

  function combineRankings(r1, r2){
    // دمج: نعطي أولوية لتقارب الشطرين: نأخذ (أدنى) الدرجتين كدرجة نهائية
    const map2 = new Map((r2||[]).map(x => [x.name, x]));
    const out = [];
    for (const x of (r1||[])){
      const y = map2.get(x.name);
      if (!y) continue;
      out.push({
        name: x.name,
        score: Math.min(x.score, y.score),
        score1: x.score,
        score2: y.score,
        tafaeel: (x.tafaeel && x.tafaeel.length ? x.tafaeel : (y.tafaeel||[]))
      });
    }
    out.sort((a,b)=>b.score-a.score);
    return out;
  }

  function renderTopBahrs(list){
    const ol = el("topBahrs");
    ol.innerHTML = "";
    const top = (list||[]).slice(0,5);
    if (!top.length){
      ol.innerHTML = "<li>—</li>";
      return;
    }
    top.forEach(item=>{
      const li = document.createElement("li");
      const pct = Math.round(item.score*100);
      const taf = (item.tafaeel && item.tafaeel.length) ? (" — " + item.tafaeel.join(" ")) : "";
      li.innerHTML = `<strong>${escapeHtml(item.name)}</strong> <span class="score">(${pct}%)</span>${escapeHtml(taf)}`;
      ol.appendChild(li);
    });
  }

  function setBestBahr(best, hasTwoShatr){
    if (!best){
      setText("bestBahr","—");
      setText("bestBahrNote","—");
      return;
    }
    const pct = Math.round(best.score*100);
    const taf = (best.tafaeel && best.tafaeel.length) ? best.tafaeel.join(" ") : "—";
    setText("bestBahr", `${best.name} (${pct}%)`);
    if (hasTwoShatr){
      const p1 = Math.round((best.score1||0)*100);
      const p2 = Math.round((best.score2||0)*100);
      setText("bestBahrNote", `تفصيل الدرجات: الشطر الأول ${p1}%، الشطر الثاني ${p2}%. التفعيلات المرجعية: ${taf}`);
    } else {
      setText("bestBahrNote", `التفعيلات المرجعية: ${taf}`);
    }
  }

  function applyDetailsToggle(){
    el("detailsWrap").style.display = el("showDetails").checked ? "block" : "none";
  }
  el("showDetails").addEventListener("change", applyDetailsToggle);

  function applyAnalysis(){
    try{
      el("errBox").style.display = "none";
      el("errBox").textContent = "";

      const input = el("bayt").value || "";
      const [s1, s2] = splitShatrain(input);
      const hasTwo = !!(s2 && s2.trim());

      el("baytVisual").innerHTML = markTextVisual(input);

      const a1 = makeArudiShatr(s1 || "");
      const a2 = makeArudiShatr(s2 || "");

      // النص العروضي (تفاصيل)
      setText("arudi1", a1.arudiText || "—");
      setText("arudi2", (hasTwo ? (a2.arudiText || "—") : "—"));

      // التحليل للنمط
      const p1 = analyzeShatrDetailedFromArudi(a1.arudiText || "", a1.map || []);
      const p2 = hasTwo ? analyzeShatrDetailedFromArudi(a2.arudiText || "", a2.map || []) : {pattern:"", vowelRatio:0, wordRows:[], steps:[]};

      const st = setStateBadge((p1.vowelRatio||0) + (p2.vowelRatio||0));
      setText("vowelState", st.txt, st.cls);

      setText("pat1", p1.pattern || "—");
      setText("pat2", (hasTwo ? (p2.pattern || "—") : "—"));

      // ====== البحور (على الصفحة الرئيسية) ======
      const r1 = rankBahrsForShatr(p1.pattern || "");
      const r2 = hasTwo ? rankBahrsForShatr(p2.pattern || "") : null;

      let finalRank = r1;
      if (hasTwo && r2){
        finalRank = combineRankings(r1, r2);
      }

      renderTopBahrs(finalRank);
      setBestBahr(finalRank && finalRank[0], hasTwo);

      // ====== التفاصيل (الجداول) ======
      if (el("showDetails").checked){
        const al = analyzeALRows(input);
        renderALTable(al.items);

        renderWordTable("w1", p1.wordRows || []);
        renderWordTable("w2", (hasTwo ? (p2.wordRows || []) : []));

        renderCharSteps("cs1", p1.steps || []);
        renderCharSteps("cs2", (hasTwo ? (p2.steps || []) : []));
      }

    } catch(e){
      showErr(e);
    }
  }

  el("analyze").addEventListener("click", applyAnalysis);
  document.querySelectorAll('input[name="unvowel"]').forEach(r => r.addEventListener("change", applyAnalysis));

  el("demo").addEventListener("click", ()=>{
    el("bayt").value = "وَضِياءُ القَمَرِ في اللَّيْلِ | وَنُورُ القَمَرِ في السَّحَرِ";
    applyAnalysis();
  });

  el("clear").addEventListener("click", ()=>{
    el("bayt").value = "";
    el("baytVisual").textContent = "—";
    setText("vowelState","—");
    setText("pat1","—");
    setText("pat2","—");
    setText("bestBahr","—");
    setText("bestBahrNote","—");
    el("topBahrs").innerHTML = "<li>—</li>";

    setText("arudi1","—");
    setText("arudi2","—");

    el("alRows").innerHTML = `<tr><td colspan="5" class="small">اكتبي نصًا ثم اضغطي: حلّل</td></tr>`;
    el("w1").innerHTML = `<tr><td colspan="5" class="small">—</td></tr>`;
    el("w2").innerHTML = `<tr><td colspan="5" class="small">—</td></tr>`;
    el("cs1").innerHTML = `<tr><td colspan="4" class="small">—</td></tr>`;
    el("cs2").innerHTML = `<tr><td colspan="4" class="small">—</td></tr>`;

    el("errBox").style.display = "none";
    el("errBox").textContent = "";
  });

  // بداية: التفاصيل مخفية
  applyDetailsToggle();

})();
</script>
</body>
</html>
