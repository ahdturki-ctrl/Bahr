<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>تحليل عروض + (ال) الشمسية/القمرية + الشدة (تفصيلي فعلي)</title>
  <style>
    :root{
      --card:#121826; --muted:#9aa4b2; --text:#e5e7eb;
      --good:#86efac; --warn:#fbbf24; --bad:#fb7185;
      --border:#243042; --sun:#fbbf24; --moon:#60a5fa; --shadda:#c084fc;
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:linear-gradient(180deg,#070a10, #0b0f14 40%, #070a10);
      color:var(--text);
      font-family: system-ui, -apple-system, "Segoe UI", Tahoma, Arial, sans-serif;
      font-size: 19px; line-height:1.65;
    }
    .wrap{max-width:1250px; margin:0 auto; padding:24px 16px 40px;}
    header{margin-bottom:18px}
    h1{font-size:28px; margin:0 0 6px}
    .sub{color:var(--muted); margin:0}
    .grid{display:grid; gap:14px; grid-template-columns: 1fr;}
    .card{
      background:rgba(18,24,38,.88);
      border:1px solid var(--border);
      border-radius:18px;
      padding:16px;
      box-shadow: 0 12px 30px rgba(0,0,0,.25);
    }
    label{display:block; margin-bottom:8px; color:#cbd5e1}
    textarea{
      width:100%; min-height:130px; resize:vertical;
      border-radius:14px; border:1px solid var(--border);
      background:#0b1220; color:var(--text);
      padding:12px 12px; font-size:19px; line-height:1.7;
      outline:none;
    }
    textarea:focus{border-color:#3b82f6}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .btn{
      appearance:none; border:1px solid var(--border);
      background:#0b1220; color:var(--text);
      padding:10px 14px; border-radius:14px;
      cursor:pointer; font-size:18px;
    }
    .btn:hover{border-color:#3b82f6}
    .btn.primary{background:rgba(59,130,246,.18); border-color:rgba(59,130,246,.55)}
    .pill{
      display:inline-flex; gap:8px; align-items:center;
      padding:6px 10px; border-radius:999px;
      border:1px solid var(--border);
      background:rgba(2,6,23,.35);
      color:var(--muted);
      font-size:16px;
    }
    .kpi{
      display:grid; gap:10px;
      grid-template-columns: repeat(3, minmax(0,1fr));
    }
    .kpi .box{
      background:rgba(2,6,23,.35);
      border:1px solid var(--border);
      border-radius:16px;
      padding:12px;
    }
    .kpi .t{color:var(--muted); font-size:15px; margin-bottom:6px}
    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:18px;
      word-break:break-word;
    }
    .hint{color:var(--muted); font-size:16px; margin:10px 0 0}
    .warn{color:var(--warn)}
    .good{color:var(--good)}
    .bad{color:var(--bad)}
    table{width:100%; border-collapse:collapse; overflow:hidden; border-radius:14px; border:1px solid var(--border)}
    th,td{padding:10px 10px; border-bottom:1px solid var(--border); vertical-align:top}
    th{background:rgba(2,6,23,.45); text-align:right; font-weight:700}
    tr:last-child td{border-bottom:none}
    .small{font-size:16px; color:var(--muted)}
    .baytBox{
      background:rgba(2,6,23,.35);
      border:1px solid var(--border);
      border-radius:16px;
      padding:12px;
      line-height:2.0;
      font-size:20px;
      word-break:break-word;
    }
    .tag{
      display:inline-flex; align-items:center; gap:8px;
      padding:3px 10px; border-radius:999px;
      border:1px solid var(--border);
      background:rgba(2,6,23,.35);
      color:var(--muted);
      font-size:15px;
    }
    .sun{
      border-bottom: 2px solid var(--sun);
      background: rgba(251,191,36,.12);
      border-radius:10px;
      padding:2px 6px;
    }
    .moon{
      border-bottom: 2px solid var(--moon);
      background: rgba(96,165,250,.12);
      border-radius:10px;
      padding:2px 6px;
    }
    .shadda{
      border-bottom: 2px solid var(--shadda);
      background: rgba(192,132,252,.12);
      border-radius:10px;
      padding:2px 6px;
    }
    .sectionTitle{margin:0 0 10px; font-size:22px}
    .split2{display:grid; grid-template-columns:1fr 1fr; gap:14px}
    @media (max-width:900px){
      .kpi{grid-template-columns:1fr}
      .split2{grid-template-columns:1fr}
      h1{font-size:24px}
      body, textarea{font-size:18px}
    }
    .radioGroup{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      padding:10px; border:1px solid var(--border); border-radius:14px;
      background:rgba(2,6,23,.28);
    }
    .radioGroup label{margin:0; color:var(--text); font-size:16px}
    .chip{display:inline-flex; gap:8px; align-items:center; padding:4px 10px; border:1px solid var(--border); border-radius:999px; background:rgba(2,6,23,.35); color:var(--muted); font-size:15px}
    .err{color:var(--bad); white-space:pre-wrap}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>تحليل عروض + (الـ) + الشدة (تفصيلي فعلي)</h1>
      <p class="sub">هذا الإصدار يُظهر تفسير الشدة حرفًا بحرف، ويُظهر تفسير (الـ) الشمسية/القمرية بوضوح داخل الجداول.</p>
    </header>

    <div class="grid">
      <section class="card">
        <label for="bayt">البيت</label>
        <textarea id="bayt" placeholder="مثال: وَالشَّمْسُ تَشْرُقُ فِي الصَّبَاحِ | وَالقَمَرُ فِي اللَّيْلِ مُنِيرٌ"></textarea>

        <div class="row" style="margin-top:10px">
          <button class="btn primary" id="analyze">حلّل</button>
          <button class="btn" id="demo">جرّب مثالًا</button>
          <button class="btn" id="clear">مسح</button>
          <span class="pill">/ = متحرك، 0 = ساكن</span>
        </div>

        <div class="row" style="margin-top:10px">
          <div class="radioGroup" title="يغيّر كيف نحسب الحروف غير المشكلة في التقطيع">
            <span class="chip">الحرف بلا تشكيل يُحسب:</span>
            <label><input type="radio" name="unvowel" value="0" checked> ساكن (0)</label>
            <label><input type="radio" name="unvowel" value="/"> متحرك (/)</label>
          </div>
        </div>

        <div id="errBox" class="err" style="margin-top:10px; display:none"></div>

        <p class="hint">
          ملاحظة: جدول “تفصيل الحروف” بالأسفل هو المرجع الأساسي: يذكر بوضوح “شدّة = ساكن (تفكيك)” ثم يذكر أثرها التالي.
        </p>
      </section>

      <section class="card">
        <div class="kpi">
          <div class="box">
            <div class="t">حالة الإدخال</div>
            <div id="vowelState" class="mono">—</div>
          </div>
          <div class="box">
            <div class="t">نمط الشطر الأوّل</div>
            <div id="pat1" class="mono">—</div>
          </div>
          <div class="box">
            <div class="t">نمط الشطر الثاني</div>
            <div id="pat2" class="mono">—</div>
          </div>
        </div>
      </section>

      <section class="card">
        <h2 class="sectionTitle">عرض بصري داخل النص</h2>
        <div class="row" style="margin-bottom:10px">
          <span class="tag"><span class="sun">شمسية</span> اللام مدغمة</span>
          <span class="tag"><span class="moon">قمرية</span> اللام ظاهرة</span>
          <span class="tag"><span class="shadda">شدّة</span> مُعلَّمة</span>
        </div>
        <div id="baytVisual" class="baytBox">—</div>
        <p class="hint small">
          هذا العرض يضع علامة على الكلمات التي تبدأ بـ (الـ) (شمسية/قمرية) ويضع علامة على الحروف المشدّدة. (التحليل الحسابي التفصيلي موجود بالجداول).
        </p>
      </section>

      <section class="card">
        <h2 class="sectionTitle">تمييز (الـ) القمرية/الشمسية + تفسير الشدة معها</h2>
        <div style="overflow:auto; margin-top:10px">
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>الكلمة</th>
                <th>النوع</th>
                <th>ألف الوصل</th>
                <th>هل الشدة مكتوبة على الحرف الشمسي؟</th>
                <th>هل أضفنا شدة افتراضية؟</th>
                <th>الكتابة العروضية (حروف فقط + تفكيك الشدة)</th>
              </tr>
            </thead>
            <tbody id="alRows">
              <tr><td colspan="7" class="small">اكتبي نصًا ثم اضغطي: حلّل</td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <section class="card">
        <h2 class="sectionTitle">التحليل التفصيلي (كلمة بكلمة + حرف بحرف)</h2>
        <div class="split2">
          <div>
            <div class="chip">الشطر الأول</div>
            <div style="margin-top:10px; overflow:auto">
              <table>
                <thead>
                  <tr>
                    <th>#</th>
                    <th>الكلمة</th>
                    <th>تفكيك الشدة (حروف)</th>
                    <th>نمط /0 للكلمة</th>
                    <th>ملاحظات</th>
                  </tr>
                </thead>
                <tbody id="w1"><tr><td colspan="5" class="small">—</td></tr></tbody>
              </table>
            </div>

            <div style="margin-top:12px; overflow:auto">
              <table>
                <thead>
                  <tr>
                    <th>الموقع</th>
                    <th>حرف + حركاته</th>
                    <th>الرمز (/0)</th>
                    <th>التفسير</th>
                  </tr>
                </thead>
                <tbody id="cs1"><tr><td colspan="4" class="small">—</td></tr></tbody>
              </table>
            </div>
          </div>

          <div>
            <div class="chip">الشطر الثاني</div>
            <div style="margin-top:10px; overflow:auto">
              <table>
                <thead>
                  <tr>
                    <th>#</th>
                    <th>الكلمة</th>
                    <th>تفكيك الشدة (حروف)</th>
                    <th>نمط /0 للكلمة</th>
                    <th>ملاحظات</th>
                  </tr>
                </thead>
                <tbody id="w2"><tr><td colspan="5" class="small">—</td></tr></tbody>
              </table>
            </div>

            <div style="margin-top:12px; overflow:auto">
              <table>
                <thead>
                  <tr>
                    <th>الموقع</th>
                    <th>حرف + حركاته</th>
                    <th>الرمز (/0)</th>
                    <th>التفسير</th>
                  </tr>
                </thead>
                <tbody id="cs2"><tr><td colspan="4" class="small">—</td></tr></tbody>
              </table>
            </div>
          </div>
        </div>

        <p class="hint small">
          قاعدة الشدة في التقطيع هنا: إذا وُجدت الشدة على حرف، نضيف أولاً “0” كجزء ساكن (تفكيك الشدة)، ثم نضيف أثر حركة الحرف إن وُجدت (مثل: شَّ = 0/ ، شْ = 00).
        </p>
      </section>
    </div>
  </div>

<script>
(() => {
  // ====== ثوابت عربية ======
  const AR_LETTER = /[\u0621-\u064A\u0671-\u06D3\u06FA-\u06FF]/;
  const HARAKAT_RE = /[\u064B-\u0652\u0670]/g; // تنوين/حركات/سكون + ألف خنجرية
  const SHADDA = "\u0651";
  const SUKUN  = "\u0652";
  const FATHA  = "\u064E";
  const DAMMA  = "\u064F";
  const KASRA  = "\u0650";
  const TANWIN_F = "\u064B";
  const TANWIN_D = "\u064C";
  const TANWIN_K = "\u064D";
  const DAGGER_A = "\u0670";

  const SUN_LETTERS = new Set(["ت","ث","د","ذ","ر","ز","س","ش","ص","ض","ط","ظ","ل","ن"]);
  const VOWELS_SET = new Set([FATHA, DAMMA, KASRA, TANWIN_F, TANWIN_D, TANWIN_K, DAGGER_A, SUKUN, SHADDA]);

  const el = (id) => document.getElementById(id);
  const setText = (id, txt, cls) => { const n = el(id); n.className = cls || "mono"; n.textContent = txt; };

  function showErr(e){
    const b = el("errBox");
    b.style.display = "block";
    b.textContent = String(e && (e.stack || e.message || e) || e);
  }
  window.addEventListener("error", (ev) => showErr(ev.error || ev.message));

  function getUnvowelMode(){
    return document.querySelector('input[name="unvowel"]:checked')?.value || "0";
  }

  function normalizeSoftKeepHarakat(s){
    return (s || "").replace(/ـ/g,"").replace(/[“”"']/g,"").replace(/\s+/g," ").trim();
  }

  function normalizeForPattern(s){
    return (s || "")
      .replace(/ـ/g,"")
      .replace(/[“”"']/g,"")
      .replace(/[(),.;:!?؟…]/g," ")
      .replace(/[0-9٠-٩]/g," ")
      .replace(/\s+/g," ")
      .trim();
  }

  function splitShatrain(s){
    if ((s || "").includes("|")) {
      const parts = s.split("|").map(x=>x.trim()).filter(Boolean);
      return [parts[0] || "", parts[1] || ""];
    }
    if ((s || "").includes("\n")) {
      const parts = s.split("\n").map(x=>x.trim()).filter(Boolean);
      return [parts[0] || "", parts[1] || ""];
    }
    return [s.trim(), ""];
  }

  // ====== ابتداء/وصل ======
  function lastNonSpaceChar(str){
    for (let i=str.length-1; i>=0; i--){
      const c = str[i];
      if (!/\s/.test(c)) return c;
    }
    return "";
  }
  function isIbtidaByPrevChar(prevChar){
    return (!prevChar || /[|،,؛;.!?؟…:\n]/.test(prevChar));
  }

  function isHarakaChar(ch){ return VOWELS_SET.has(ch); }

  function skipHarakat(str, idx){
    let i = idx;
    while (i < str.length && isHarakaChar(str[i])) i++;
    return i;
  }

  function getNextArabicLetter(str, idx){
    let i = idx;
    while (i < str.length){
      if (isHarakaChar(str[i])) { i++; continue; }
      if (AR_LETTER.test(str[i])) return {ch:str[i], index:i};
      i++;
    }
    return null;
  }

  function stripEdgePunctKeepHarakat(w){
    return (w || "").replace(/^[\u200f\u200e"'“”‘’\(\)\[\]\{\}\.,;:!?؟]+|[\u200f\u200e"'“”‘’\(\)\[\]\{\}\.,;:!?؟]+$/g, "");
  }

  function splitFirstLetterAndMarks(s){
    let i = 0;
    while (i < s.length && !AR_LETTER.test(s[i])) i++;
    if (i >= s.length) return null;
    const ch = s[i];
    let j = i+1;
    let marks = "";
    while (j < s.length && isHarakaChar(s[j])) { marks += s[j]; j++; }
    const rest = s.slice(j);
    return {ch, marks, rest};
  }

  function expandShaddaLettersOnly(s){
    // يزيل الحركات، ويكرر الحرف المشدد مرة واحدة
    let out = "";
    for (let i=0; i<s.length; i++){
      const ch = s[i];
      if (!AR_LETTER.test(ch)) continue;

      let marks = "";
      let j = i+1;
      while (j < s.length && isHarakaChar(s[j])) { marks += s[j]; j++; }

      out += marks.includes(SHADDA) ? (ch + ch) : ch;
      i = j-1;
    }
    return out;
  }

  function escapeHtml(str){
    return (str || "").replace(/[&<>"']/g, (m)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
  }

  // ====== عرض بصري: تمييز (الـ) + تمييز الحروف المشددة ======
  function markTextVisual(text){
    const s = normalizeSoftKeepHarakat(text);
    if (!s) return "—";
    const tokens = s.split(/(\s+)/);
    let out = "";

    for (const tok of tokens){
      if (/^\s+$/.test(tok)) { out += tok; continue; }
      const raw = tok;
      const w = stripEdgePunctKeepHarakat(raw);

      // نبني نسخة من w تضع علامة على الحرف المشدد
      function markShaddaInWord(word){
        let res = "";
        for (let i=0; i<word.length; i++){
          const ch = word[i];
          if (!AR_LETTER.test(ch)) { res += escapeHtml(ch); continue; }

          // اجمع الحركات بعد الحرف
          let marks = "";
          let j = i+1;
          while (j < word.length && isHarakaChar(word[j])) { marks += word[j]; j++; }

          const chunk = escapeHtml(ch + marks);
          if (marks.includes(SHADDA)) res += `<span class="shadda" title="شدّة">${chunk}</span>`;
          else res += chunk;

          i = j-1;
        }
        return res;
      }

      // تمييز (الـ) شمسية/قمرية (مع دعم: وَالـ/فَالـ/بِالـ/كَالـ/لِلـ ...)
      let kindCls = "";
      {
        let startAt = 0;
        let hasClitic = false;
        if (w.length >= 3) {
          const first = w[0];
          const next2 = w.slice(1,3);
          if ("وفبكل".includes(first) && (next2 === "ال" || next2 === "ٱل")) { hasClitic = true; startAt = 1; }
        }
        const hasAL = (w.startsWith("ال") || w.startsWith("ٱل") || (startAt===1 && (w.slice(1,3)==="ال" || w.slice(1,3)==="ٱل")));
        if (hasAL){
          const lamIdx = startAt + 1;
          const afterLam = skipHarakat(w, lamIdx+1);
          const nxt = getNextArabicLetter(w, afterLam);
          if (nxt){
            const sun = SUN_LETTERS.has(nxt.ch);
            kindCls = sun ? "sun" : "moon";
          }
        }
      }

      const markedWord = markShaddaInWord(w);
      if (kindCls) out += `<span class="${kindCls}" title="(الـ)">${markedWord}</span>`;
      else out += markedWord;
    }
    return out || "—";
  }

  // ====== (الـ) تحليل وتفسير فعلي ======
  function analyzeALRows(text){
    const original = (text || "").trim();
    if (!original) return {items:[]};

    const tokens = normalizeSoftKeepHarakat(original).split(/(\s+)/);
    const items = [];

    let builtSoFarPlain = "";

    for (const tok of tokens){
      if (/^\s+$/.test(tok)) { builtSoFarPlain += tok; continue; }

      const rawWord = tok;
      const w = stripEdgePunctKeepHarakat(rawWord);
      if (!w) { builtSoFarPlain += rawWord; continue; }

      // دعم سابقات: وَالـ/فَالـ/بِالـ/كَالـ/لِلـ
      let startAt = 0;
      let hasClitic = false;

      if (w.length >= 3) {
        const first = w[0];
        const next2 = w.slice(1,3);
        if ("وفبكل".includes(first) && (next2 === "ال" || next2 === "ٱل")) { hasClitic = true; startAt = 1; }
      }
      // للـ (لام جر + ال)
      if (w.length >= 3 && w[0] === "ل" && (w.slice(1,3) === "ال" || w.slice(1,3) === "ٱل")) { hasClitic = true; startAt = 1; }

      const hasAL = (w.startsWith("ال") || w.startsWith("ٱل") || (startAt===1 && (w.slice(1,3)==="ال" || w.slice(1,3)==="ٱل")));
      if (!hasAL){ builtSoFarPlain += rawWord; continue; }

      const lamIdx = startAt + 1;
      const afterLam = skipHarakat(w, lamIdx+1);
      const nxt = getNextArabicLetter(w, afterLam);
      if (!nxt){ builtSoFarPlain += rawWord; continue; }

      const sun = SUN_LETTERS.has(nxt.ch);
      const kind = sun ? "شمسية" : "قمرية";

      // ابتداء/وصل
      const prevChar = lastNonSpaceChar(builtSoFarPlain);
      const ibtida = hasClitic ? false : isIbtidaByPrevChar(prevChar);
      const hamzaWasl = ibtida ? "تُنطق (اَ) ابتداءً" : "لا تُنطق وصلاً";

      const stemRaw = w.slice(afterLam);

      // هل الشدة مكتوبة على الحرف الشمسي فعلًا؟
      let shaddaWritten = "—";
      let shaddaAdded = "—";

      let arudi = "";
      if (!sun){
        shaddaWritten = "—";
        shaddaAdded = "—";
        arudi = (ibtida ? "اَلْ" : "لْ") + expandShaddaLettersOnly(stemRaw);
      } else {
        const first = splitFirstLetterAndMarks(stemRaw);
        if (first){
          const has = (first.marks || "").includes(SHADDA);
          shaddaWritten = has ? "نعم" : "لا";
          shaddaAdded = has ? "لا" : "نعم";
          let marks = first.marks || "";
          if (!marks.includes(SHADDA)) marks += SHADDA; // نضيفها فقط إذا لم تكن موجودة
          const ensured = first.ch + marks + first.rest;
          arudi = (ibtida ? "اَ" : "") + expandShaddaLettersOnly(ensured);
        } else {
          shaddaWritten = "غير واضح";
          shaddaAdded = "غير واضح";
          arudi = (ibtida ? "اَ" : "") + expandShaddaLettersOnly(stemRaw);
        }
      }

      items.push({
        word: w,
        kind,
        hamzaWasl,
        shaddaWritten,
        shaddaAdded,
        arudi
      });

      builtSoFarPlain += rawWord;
    }

    return {items};
  }

  // ====== تقطيع تفصيلي فعلي (الحرف بحركاته + تفسير الشدة) ======
  function tokenizeLettersWithMarks(text){
    const out = [];
    const s = text;
    for (let i=0; i<s.length; i++){
      const ch = s[i];
      if (!AR_LETTER.test(ch)) continue;

      let marks = "";
      let j = i+1;
      while (j < s.length && HARAKAT_RE.test(s[j])) { marks += s[j]; j++; }
      HARAKAT_RE.lastIndex = 0;

      out.push({ch, marks});
      i = j-1;
    }
    return out;
  }

  function hasAnyVowel(marks){
    return marks.includes(FATHA) || marks.includes(DAMMA) || marks.includes(KASRA) ||
           marks.includes(TANWIN_F) || marks.includes(TANWIN_D) || marks.includes(TANWIN_K) ||
           marks.includes(DAGGER_A);
  }
  function vowelType(marks){
    if (marks.includes(FATHA) || marks.includes(TANWIN_F) || marks.includes(DAGGER_A)) return "a";
    if (marks.includes(DAMMA) || marks.includes(TANWIN_D)) return "u";
    if (marks.includes(KASRA) || marks.includes(TANWIN_K)) return "i";
    return "";
  }
  function isLongVowelLetter(ch){
    return ch === "ا" || ch === "و" || ch === "ي" || ch === "ى";
  }

  function analyzeWordPatternDetailed(word){
    const mode = getUnvowelMode(); // "0" أو "/"
    const tks = tokenizeLettersWithMarks(word);
    let p = "";
    const steps = [];
    const notes = [];

    for (let i=0; i<tks.length; i++){
      const t = tks[i];
      const m = t.marks || "";

      // 1) الشدة: نضيف ساكن (تفكيك)
      if (m.includes(SHADDA)){
        p += "0";
        steps.push({display: t.ch + m, sym:"0", why:"شدّة: تفكيكها = جزء ساكن (0) قبل بقية أثر الحرف"});
      }

      // 2) أثر الحرف نفسه بعد التفكيك
      if (m.includes(SUKUN)) {
        p += "0";
        steps.push({display: t.ch + m, sym:"0", why:"سكون: الحرف ساكن (0)"});
      } else if (hasAnyVowel(m)) {
        p += "/";
        steps.push({display: t.ch + m, sym:"/", why:"حركة ظاهرة على الحرف = متحرك (/)"});

        // التنوين = حركة + نون ساكنة
        if (m.includes(TANWIN_F) || m.includes(TANWIN_D) || m.includes(TANWIN_K)){
          p += "0";
          steps.push({display: "ـنْ (ضمن التنوين)", sym:"0", why:"تنوين: يُعامل كنون ساكنة بعد الحركة"});
        }
      } else {
        p += mode;
        steps.push({display: t.ch, sym:mode, why: (mode==="0" ? "بلا تشكيل: اعتُبر ساكنًا (حسب خيارك)" : "بلا تشكيل: اعتُبر متحركًا (حسب خيارك)")});
      }

      // 3) المدّ: حرف مد بعد حركة مناسبة
      const vt = vowelType(m);
      if (vt && i+1 < tks.length) {
        const n = tks[i+1];
        const nm = n.marks || "";
        if (!hasAnyVowel(nm) && !nm.includes(SUKUN) && isLongVowelLetter(n.ch)) {
          const ok =
            (vt === "a" && (n.ch === "ا" || n.ch === "ى")) ||
            (vt === "u" && n.ch === "و") ||
            (vt === "i" && n.ch === "ي");
          if (ok){
            p += "0";
            steps.push({display: n.ch, sym:"0", why:"مدّ: حرف مد بعد حركة مناسبة يُحسب ساكنًا (0)"});
            i++;
          }
        }
      }
    }

    // ملاحظات سريعة للكلمة
    if (word.includes(SHADDA)) notes.push("يوجد شدّة");
    if (word.includes(TANWIN_F) || word.includes(TANWIN_D) || word.includes(TANWIN_K)) notes.push("يوجد تنوين");
    if (word.includes(SUKUN)) notes.push("يوجد سكون");
    return {pattern:p.replace(/[^\/0]/g,""), steps, expanded: expandShaddaLettersOnly(word), notes: notes.join("، ") || "—"};
  }

  function analyzeTextDetailed(shatr){
    const raw = normalizeForPattern(shatr);
    const marksCount = (raw.match(HARAKAT_RE) || []).length;
    HARAKAT_RE.lastIndex = 0;
    const lettersCount = (raw.match(/[\u0621-\u064A\u0671-\u06D3\u06FA-\u06FF]/g) || []).length;
    const vowelRatio = lettersCount ? (marksCount / lettersCount) : 0;

    const words = raw.split(/\s+/).filter(Boolean).map(w => stripEdgePunctKeepHarakat(w)).filter(Boolean);
    let pattern = "";
    let steps = [];
    let wordRows = [];
    let pos = 0;

    for (let wi=0; wi<words.length; wi++){
      const w = words[wi];
      const r = analyzeWordPatternDetailed(w);
      wordRows.push({idx:wi+1, word:w, expanded:r.expanded, pat:r.pattern, notes:r.notes});
      pattern += r.pattern;

      for (const st of r.steps){
        steps.push({pos: ++pos, display: st.display, sym: st.sym, why: st.why});
      }
    }

    return {raw, pattern, vowelRatio, wordRows, steps};
  }

  function setStateBadge(vowelRatio){
    if (vowelRatio >= 0.35) return {txt:"مُشكَّل بدرجة جيدة", cls:"mono good"};
    if (vowelRatio >= 0.15) return {txt:"تشكيل قليل (اعتمدي جدول التفصيل)", cls:"mono warn"};
    return {txt:"بلا تشكيل تقريبًا (قد لا يثبت الوزن)", cls:"mono bad"};
  }

  function renderALTable(items){
    const body = el("alRows");
    body.innerHTML = "";
    if (!items.length){
      body.innerHTML = `<tr><td colspan="7" class="small">لا توجد كلمات تبدأ بـ (الـ) في النص.</td></tr>`;
      return;
    }
    items.forEach((it, idx)=>{
      const tr = document.createElement("tr");
      const cls = (it.kind === "شمسية") ? "sun" : "moon";
      tr.innerHTML = `
        <td>${idx+1}</td>
        <td><strong>${escapeHtml(it.word)}</strong></td>
        <td><span class="${cls}">${it.kind}</span></td>
        <td>${escapeHtml(it.hamzaWasl)}</td>
        <td>${escapeHtml(it.shaddaWritten)}</td>
        <td>${escapeHtml(it.shaddaAdded)}</td>
        <td class="mono">${escapeHtml(it.arudi)}</td>
      `;
      body.appendChild(tr);
    });
  }

  function renderWordTable(tbodyId, wordRows){
    const body = el(tbodyId);
    body.innerHTML = "";
    if (!wordRows.length){
      body.innerHTML = `<tr><td colspan="5" class="small">—</td></tr>`;
      return;
    }
    wordRows.forEach(r=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${r.idx}</td>
        <td><strong>${escapeHtml(r.word)}</strong></td>
        <td class="mono">${escapeHtml(r.expanded)}</td>
        <td class="mono">${escapeHtml(r.pat)}</td>
        <td class="small">${escapeHtml(r.notes)}</td>
      `;
      body.appendChild(tr);
    });
  }

  function renderCharSteps(tbodyId, steps){
    const body = el(tbodyId);
    body.innerHTML = "";
    if (!steps.length){
      body.innerHTML = `<tr><td colspan="4" class="small">—</td></tr>`;
      return;
    }
    steps.forEach(s=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${s.pos}</td>
        <td class="mono">${escapeHtml(s.display)}</td>
        <td class="mono"><strong>${escapeHtml(s.sym)}</strong></td>
        <td class="small">${escapeHtml(s.why)}</td>
      `;
      body.appendChild(tr);
    });
  }

  // ====== تشغيل التحليل ======
  function applyAnalysis(){
    try{
      el("errBox").style.display = "none";
      el("errBox").textContent = "";

      const input = el("bayt").value || "";
      const [s1, s2] = splitShatrain(input);

      // عرض بصري
      el("baytVisual").innerHTML = markTextVisual(input);

      // جدول (الـ)
      const al = analyzeALRows(input);
      renderALTable(al.items);

      // تحليل تفصيلي للشطرين
      const p1 = analyzeTextDetailed(s1 || "");
      const p2 = analyzeTextDetailed(s2 || "");

      const st = setStateBadge((p1.vowelRatio||0) + (p2.vowelRatio||0));
      setText("vowelState", st.txt, st.cls);

      setText("pat1", p1.pattern || "—", "mono");
      setText("pat2", (s2.trim() ? (p2.pattern || "—") : "—"), "mono");

      renderWordTable("w1", p1.wordRows || []);
      renderWordTable("w2", (s2.trim() ? (p2.wordRows || []) : []));

      renderCharSteps("cs1", p1.steps || []);
      renderCharSteps("cs2", (s2.trim() ? (p2.steps || []) : []));

      // ملاحظة: لم أعد أعرض “البحر” هنا لأن المشكلة عندك في الأساس هي قواعد الشدة/الـ.
      // إذا تبين، أرجّع قسم البحر لاحقًا بعد ما نتأكد أن التقطيع نفسه صار صحيحًا عندك.
    } catch(e){
      showErr(e);
    }
  }

  // ====== أحداث ======
  el("analyze").addEventListener("click", applyAnalysis);
  document.querySelectorAll('input[name="unvowel"]').forEach(r => r.addEventListener("change", applyAnalysis));

  el("demo").addEventListener("click", ()=>{
    el("bayt").value = "وَالشَّمْسُ تَشْرُقُ فِي الصَّبَاحِ | وَالقَمَرُ فِي اللَّيْلِ مُنِيرٌ";
    applyAnalysis();
  });

  el("clear").addEventListener("click", ()=>{
    el("bayt").value = "";
    el("baytVisual").textContent = "—";
    setText("vowelState","—");
    setText("pat1","—");
    setText("pat2","—");
    el("alRows").innerHTML = `<tr><td colspan="7" class="small">اكتبي نصًا ثم اضغطي: حلّل</td></tr>`;
    el("w1").innerHTML = `<tr><td colspan="5" class="small">—</td></tr>`;
    el("w2").innerHTML = `<tr><td colspan="5" class="small">—</td></tr>`;
    el("cs1").innerHTML = `<tr><td colspan="4" class="small">—</td></tr>`;
    el("cs2").innerHTML = `<tr><td colspan="4" class="small">—</td></tr>`;
    el("errBox").style.display = "none";
    el("errBox").textContent = "";
  });

})();
</script>
</body>
</html>
